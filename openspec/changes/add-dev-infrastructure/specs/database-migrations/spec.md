# database-migrations Specification

## Purpose
Define versioned database migrations using Alembic integrated with SQLModel, supporting schema evolution, autogeneration from model changes, and safe upgrade/downgrade operations.

## ADDED Requirements

### Requirement: Migration Environment

The system SHALL provide an Alembic environment configured for SQLModel.

#### Scenario: Alembic configuration exists
- **WHEN** developer looks for migration configuration
- **THEN** `migrations/alembic.ini` exists at the repository root

#### Scenario: Environment uses SQLModel metadata
- **WHEN** Alembic runs
- **THEN** it uses `SQLModel.metadata` for schema comparison

#### Scenario: Migration scripts directory
- **WHEN** migrations are created
- **THEN** they are stored in `migrations/versions/`

### Requirement: Migration Generation

The system SHALL support autogenerated migrations from model changes.

#### Scenario: Autogenerate migration
- **WHEN** developer runs `alembic revision --autogenerate -m "description"`
- **THEN** Alembic compares models to database schema
- **AND** generates a migration script with detected changes

#### Scenario: Empty migration prevented
- **WHEN** autogenerate runs with no schema differences
- **THEN** no migration file is created

#### Scenario: Migration has upgrade and downgrade
- **WHEN** a migration is generated
- **THEN** it includes both `upgrade()` and `downgrade()` functions

### Requirement: Migration Execution

The system SHALL provide commands to run migrations.

#### Scenario: Upgrade to latest
- **WHEN** `alembic upgrade head` runs
- **THEN** all pending migrations are applied in order

#### Scenario: Upgrade to specific version
- **WHEN** `alembic upgrade <revision>` runs
- **THEN** migrations up to and including that revision are applied

#### Scenario: Downgrade one version
- **WHEN** `alembic downgrade -1` runs
- **THEN** the most recent migration is reverted

#### Scenario: Migration tracking
- **WHEN** a migration completes successfully
- **THEN** the revision is recorded in `alembic_version` table

### Requirement: Migration Safety

The system SHALL ensure migrations are safe and reversible.

#### Scenario: Transaction per migration
- **WHEN** a migration runs
- **THEN** it executes within a transaction
- **AND** rolls back on failure

#### Scenario: Check for pending migrations
- **WHEN** application starts in production
- **THEN** it can detect if migrations are pending (without auto-applying)

#### Scenario: Offline migration support
- **WHEN** developer runs `alembic upgrade head --sql`
- **THEN** SQL statements are printed instead of executed
- **AND** can be reviewed or run manually

### Requirement: Initial Migration

The system SHALL support creating an initial migration from existing schema.

#### Scenario: Generate initial migration
- **WHEN** database has existing tables but no alembic_version
- **THEN** `alembic revision --autogenerate -m "initial"` creates baseline migration

#### Scenario: Stamp existing database
- **WHEN** existing database should skip initial migration
- **THEN** `alembic stamp head` marks it as up-to-date without running migrations

### Requirement: CLI Integration

The system SHALL integrate migration commands into the JDO CLI.

#### Scenario: Check migration status
- **WHEN** user runs `jdo db status`
- **THEN** current revision and pending migrations are displayed

#### Scenario: Apply migrations via CLI
- **WHEN** user runs `jdo db upgrade`
- **THEN** pending migrations are applied

#### Scenario: Generate migration via CLI
- **WHEN** developer runs `jdo db revision "add user table"`
- **THEN** a new migration is generated with the given message

### Requirement: SQLite Compatibility

The system SHALL handle SQLite-specific migration constraints.

#### Scenario: Batch operations for ALTER TABLE
- **WHEN** a migration alters a column in SQLite
- **THEN** Alembic uses batch mode (copy-table strategy)

#### Scenario: Foreign key handling
- **WHEN** migrations run on SQLite
- **THEN** foreign keys are properly re-enabled after batch operations
